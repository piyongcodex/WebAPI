version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword123
      MYSQL_DATABASE: userdb
      MYSQL_USER: myuser
      MYSQL_PASSWORD: myuserpassword123
    ports:
      - "3307:3306"  # External port 3307, internal 3306
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - mynetwork

  keycloak:
    image: quay.io/keycloak/keycloak
    container_name: keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    command: start-dev
    ports:
      - "8082:8080"  # External port 8082, internal 8080
    networks:
      - mynetwork

  api:
    image: localhost/cqrs-pattern
    container_name: my-api
    environment:
      # Override connection string
      - ConnectionStrings__DefaultConnection=Server=mysql;Port=3306;Database=userdb;User=myuser;Password=myuserpassword123;
      
      # Override Keycloak authority
      - Keycloak__Authority=http://keycloak:8080/realms/myrealm
      - Keycloak__Audience=your-client-id
      
      # Optional: Override other settings
      - ASPNETCORE_ENVIRONMENT=Production
    ports:
      - "5000:8080"
    depends_on:
      - mysql
      - keycloak
    networks:
      - mynetwork

networks:
  mynetwork:
    driver: bridge

volumes:
  mysql_data: